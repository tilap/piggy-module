'use strict';var _get=require('babel-runtime/helpers/get')['default'];var _inherits=require('babel-runtime/helpers/inherits')['default'];var _createClass=require('babel-runtime/helpers/create-class')['default'];var _classCallCheck=require('babel-runtime/helpers/class-call-check')['default'];var _Object$keys=require('babel-runtime/core-js/object/keys')['default'];var _Promise=require('babel-runtime/core-js/promise')['default'];var _interopRequireDefault=require('babel-runtime/helpers/interop-require-default')['default'];Object.defineProperty(exports,'__esModule',{value:true});var _piggyModuleLibStorageAbstract=require('piggy-module/lib/Storage/Abstract');var _piggyModuleLibStorageAbstract2=_interopRequireDefault(_piggyModuleLibStorageAbstract);var _piggyModuleLibStorageErrors=require('piggy-module/lib/Storage/Errors');var ApiStorage=(function(_AbstractStorage){_inherits(ApiStorage,_AbstractStorage);function ApiStorage(connector,collection){_classCallCheck(this,ApiStorage);_get(Object.getPrototypeOf(ApiStorage.prototype),'constructor',this).call(this,connector,collection);}_createClass(ApiStorage,[{key:'get',value:function get(){var criteria=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];var options=arguments.length <= 1 || arguments[1] === undefined?{}:arguments[1];var params={'criteria':criteria,'options':options};return this._runRequest('get','',params,{},[]);}},{key:'insertOne',value:function insertOne(){var data=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];return this._runRequest('post','',{},data);}},{key:'delete',value:function _delete(){var criteria=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];return this._runRequest('delete','',{'criteria':criteria});}},{key:'_getFetcherUrl',value:function _getFetcherUrl(){var path=arguments.length <= 0 || arguments[0] === undefined?'':arguments[0];var params=arguments.length <= 1 || arguments[1] === undefined?{}:arguments[1];var url=this._connector + this._collection + path;if(params && _Object$keys(params).length > 0){(function(){var args=[];_Object$keys(params).forEach(function(key){var value=encodeURIComponent(JSON.stringify(params[key]));args.push(key + '=' + value);});if(args.length > 0){url += '?' + args.join('&');}})();}return url;}},{key:'_getFetcherOptions',value:function _getFetcherOptions(method){var postData=arguments.length <= 1 || arguments[1] === undefined?{}:arguments[1];method = method.toLowerCase();if(['get','post','put','delete'].indexOf(method) < 0){throw new Error('Unknwon fetch method ' + method);}var options={'method':method,'headers':{'Accept':'application/json','Content-Type':'application/json'}};var hasData=postData && _Object$keys(postData).length > 0;if(['post','put'].indexOf(method) > -1 && hasData){options.body = JSON.stringify(postData);}return options;}},{key:'_runRequest',value:function _runRequest(method){var path=arguments.length <= 1 || arguments[1] === undefined?'':arguments[1];var params=arguments.length <= 2 || arguments[2] === undefined?{}:arguments[2];var _this=this;var postData=arguments.length <= 3 || arguments[3] === undefined?{}:arguments[3];var defaultValue=arguments.length <= 4 || arguments[4] === undefined?{}:arguments[4];var url=this._getFetcherUrl(path,params);var options=this._getFetcherOptions(method,postData);return new _Promise(function(resolve,reject){fetch(url,options)['catch'](function(error){if(error.constructor.name === 'TypeError'){return reject(new _piggyModuleLibStorageErrors.UnreachableStorage());}return reject(error);}).then(function(response){if(response.ok){return response;}var error=new Error(response.statusText);error.response = response;return reject(error);}).then(function(response){return response.json();}).then(function(json){if(_this._isJsonPiggyResult(json)){return _this._extractPiggyData(json,defaultValue);}if(_this._isJsonPiggyError(json)){return json;}if(json.hasOwnProperty('data')){return json.data;}return json;}).then(function(res){resolve(res);})['catch'](function(err){reject(err);});});}},{key:'_isJsonPiggyError',value:function _isJsonPiggyError(json){return json.hasOwnProperty('errors');}},{key:'_isJsonPiggyResult',value:function _isJsonPiggyResult(json){if(!json.data){return false;}var isPiggyModuleResult=true;if(json.data.constructor === Array){json.data.forEach(function(item){if(!item.attributes){isPiggyModuleResult = false;}});}else if(!json.data.attributes){isPiggyModuleResult = false;}return isPiggyModuleResult;}},{key:'_extractPiggyData',value:function _extractPiggyData(json,defaultValue){var data=undefined;if(!json.data){data = defaultValue;}else if(json.data.constructor === Array){data = json.data.map(function(item){return item.attributes;});}else {data = json.data.attributes;}return data;}}]);return ApiStorage;})(_piggyModuleLibStorageAbstract2['default']);exports['default'] = ApiStorage;module.exports = exports['default'];
//# sourceMappingURL=../Storage/Api.js.map