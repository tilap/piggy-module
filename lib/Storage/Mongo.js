'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _createClass=(function(){function defineProperties(target,props){for(var i=0;i < props.length;i++) {var descriptor=props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if('value' in descriptor)descriptor.writable = true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};})();var _get=function get(_x4,_x5,_x6){var _again=true;_function: while(_again) {var object=_x4,property=_x5,receiver=_x6;desc = parent = getter = undefined;_again = false;if(object === null)object = Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc === undefined){var parent=Object.getPrototypeOf(object);if(parent === null){return undefined;}else {_x4 = parent;_x5 = property;_x6 = receiver;_again = true;continue _function;}}else if('value' in desc){return desc.value;}else {var getter=desc.get;if(getter === undefined){return undefined;}return getter.call(receiver);}}};function _interopRequireDefault(obj){return obj && obj.__esModule?obj:{'default':obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function');}}function _inherits(subClass,superClass){if(typeof superClass !== 'function' && superClass !== null){throw new TypeError('Super expression must either be null or a function, not ' + typeof superClass);}subClass.prototype = Object.create(superClass && superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__ = superClass;}var _Abstract=require('./Abstract');var _Abstract2=_interopRequireDefault(_Abstract);var _mongodb=require('mongodb');var MongoStorage=(function(_AbstractStorage){_inherits(MongoStorage,_AbstractStorage);function MongoStorage(collection){_classCallCheck(this,MongoStorage);_get(Object.getPrototypeOf(MongoStorage.prototype),'constructor',this).call(this,collection);}_createClass(MongoStorage,[{key:'get',value:function get(){var _this=this;var criteria=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];var options=arguments.length <= 1 || arguments[1] === undefined?{}:arguments[1];criteria = this._prepareCriteria(criteria);return new Promise(function(resolve,reject){_this._collection.find(criteria,options).toArray(function(err,items){if(err){return reject(new Error('Storage error in get()'));}resolve(items);});});}},{key:'insertOne',value:function insertOne(){var _this2=this;var data=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];return new Promise(function(resolve,reject){_this2._collection.insert(data,function(err,insertResult){if(err){return reject(new Error('Storage error: insert() ' + err.message));}if(!insertResult.ops || insertResult.ops.length !== 1){return reject(new Error('Storage error: non unique result'));}var insertedDatas=insertResult.ops[0];resolve(insertedDatas);});});}},{key:'updateOne',value:function updateOne(criteria,newData){var _this3=this;var options={upsert:false,multi:false};criteria = this._prepareCriteria(criteria);newData = this._stripIdCriteria(newData);return new Promise(function(resolve,reject){_this3._collection.update(criteria,{$set:newData},options,function(err,updateResult){if(err){return reject(new Error('Storage error: update() ' + err.message));}_this3.get(criteria).then(function(vos){if(!vos[0]){return reject('Error post update #1');}var res=vos[0];return resolve(res);})['catch'](function(err){return reject('Error post update #2');});});});}},{key:'delete',value:function _delete(criteria){var _this4=this;criteria = this._prepareCriteria(criteria);return new Promise(function(resolve,reject){_this4._collection.deleteMany(criteria,function(err,deleteResult){console.log(deleteResult);if(err){return reject(new Error('Storage error: delete() ' + err.message));}var deletedDocumentsCount=deleteResult.result.n;resolve(deletedDocumentsCount);});});}},{key:'_prepareCriteria',value:function _prepareCriteria(criteria){if(criteria._id){if(criteria._id.constructor === String){criteria._id = new _mongodb.ObjectId(criteria._id);}if(criteria._id.$in){criteria._id.$in = criteria._id.$in.map(function(idStr){return new _mongodb.ObjectId(idStr);});}}return criteria;}},{key:'_stripIdCriteria',value:function _stripIdCriteria(criteria){if(criteria._id){delete criteria._id;}return criteria;}}]);return MongoStorage;})(_Abstract2['default']);exports['default'] = MongoStorage;module.exports = exports['default'];
//# sourceMappingURL=../Storage/Mongo.js.map