'use strict';var _get=require('babel-runtime/helpers/get')['default'];var _inherits=require('babel-runtime/helpers/inherits')['default'];var _createClass=require('babel-runtime/helpers/create-class')['default'];var _classCallCheck=require('babel-runtime/helpers/class-call-check')['default'];var _Promise=require('babel-runtime/core-js/promise')['default'];var _interopRequireDefault=require('babel-runtime/helpers/interop-require-default')['default'];Object.defineProperty(exports,'__esModule',{value:true});var _Abstract=require('./Abstract');var _Abstract2=_interopRequireDefault(_Abstract);var _mongodb=require('mongodb');var MongoStorage=(function(_AbstractStorage){_inherits(MongoStorage,_AbstractStorage);function MongoStorage(connector,collection){_classCallCheck(this,MongoStorage);_get(Object.getPrototypeOf(MongoStorage.prototype),'constructor',this).call(this,connector,collection);}_createClass(MongoStorage,[{key:'getCollection',value:function getCollection(){var _this=this;return new _Promise(function(resolve,reject){_this._connector.getCollection(_this._collection).then(function(collection){return resolve(collection);})['catch'](function(error){console.error('MongoStorage getCollection error',error);reject(error);});});}},{key:'get',value:function get(){var _this2=this;var criteria=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];var options=arguments.length <= 1 || arguments[1] === undefined?{}:arguments[1];criteria = this._prepareCriteria(criteria);return new _Promise(function(resolve,reject){_this2.getCollection().then(function(collection){collection.find(criteria,options).toArray(function(err,items){if(err){return reject(new Error('Storage error in get()'));}resolve(items);});})['catch'](function(error){console.error('MongoStorage error',error);reject(error);});});}},{key:'insertOne',value:function insertOne(){var _this3=this;var data=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];return new _Promise(function(resolve,reject){_this3.getCollection().then(function(collection){collection.insert(data,function(err,insertResult){if(err){return reject(new Error('Storage error: insert() ' + err.message));}if(!insertResult.ops || insertResult.ops.length !== 1){return reject(new Error('Storage error: non unique result'));}var insertedDatas=insertResult.ops[0];resolve(insertedDatas);});})['catch'](function(error){return reject(error);});});}},{key:'updateOne',value:function updateOne(criteria,newData){var _this4=this;var options={upsert:false,multi:false};criteria = this._prepareCriteria(criteria);newData = this._stripIdCriteria(newData);return new _Promise(function(resolve,reject){_this4.getCollection().then(function(collection){collection.update(criteria,{$set:newData},options,function(err,updateResult){if(err){return reject(new Error('Storage error: update() ' + err.message));}_this4.get(criteria).then(function(vos){if(!vos[0]){return reject('Error post update #1');}var res=vos[0];return resolve(res);})['catch'](function(err){return reject('Error post update #2');});});})['catch'](function(error){return reject(error);});});}},{key:'delete',value:function _delete(criteria){var _this5=this;criteria = this._prepareCriteria(criteria);return new _Promise(function(resolve,reject){_this5.getCollection().then(function(collection){collection.deleteMany(criteria,function(err,deleteResult){if(err){return reject(new Error('Storage error: delete() ' + err.message));}var deletedDocumentsCount=deleteResult.result.n;resolve({'deletedCount':deletedDocumentsCount});});})['catch'](function(error){return reject(error);});});}},{key:'_prepareCriteria',value:function _prepareCriteria(criteria){if(criteria._id){if(criteria._id.constructor === String){criteria._id = new _mongodb.ObjectId(criteria._id);}if(criteria._id.$in){criteria._id.$in = criteria._id.$in.map(function(idStr){return new _mongodb.ObjectId(idStr);});}}return criteria;}},{key:'_stripIdCriteria',value:function _stripIdCriteria(criteria){if(criteria._id){delete criteria._id;}return criteria;}}]);return MongoStorage;})(_Abstract2['default']);exports['default'] = MongoStorage;module.exports = exports['default'];
//# sourceMappingURL=../Storage/Mongo.js.map