'use strict';var _createClass=require('babel-runtime/helpers/create-class')['default'];var _classCallCheck=require('babel-runtime/helpers/class-call-check')['default'];var _Promise=require('babel-runtime/core-js/promise')['default'];var _Object$keys=require('babel-runtime/core-js/object/keys')['default'];var _Object$getOwnPropertyNames=require('babel-runtime/core-js/object/get-own-property-names')['default'];var _Object$defineProperty=require('babel-runtime/core-js/object/define-property')['default'];var _interopRequireDefault=require('babel-runtime/helpers/interop-require-default')['default'];Object.defineProperty(exports,'__esModule',{value:true});var _ValidationPropertyError=require('./ValidationPropertyError');var _ValidationPropertyError2=_interopRequireDefault(_ValidationPropertyError);var _ValidationError=require('./ValidationError');var _ValidationError2=_interopRequireDefault(_ValidationError);var Manager=(function(){function Manager(storage){_classCallCheck(this,Manager);this.storage = storage;}_createClass(Manager,[{key:'assumeIsOwnVoClass',value:function assumeIsOwnVoClass(vo){if(vo.constructor.name !== this.constructor.voClass.name){throw new Error('Manager.assumeIsOwnVoClass() error: ' + this.constructor.voClass.name + ' expected class instace');}}},{key:'getNewVo',value:function getNewVo(){var data=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];return new this.constructor.voClass(data);}},{key:'get',value:function get(){var _this=this;var criteria=arguments.length <= 0 || arguments[0] === undefined?{}:arguments[0];var options=arguments.length <= 1 || arguments[1] === undefined?{}:arguments[1];return this.storage.get(criteria,options).then(function(items){var res=[];if(items.constructor === Array){items.map(function(item){res.push(_this.getNewVo(item));});}return res;});}},{key:'saveOne',value:function saveOne(vo){return vo.id?this.updateOne(vo):this.insertOne(vo);}},{key:'insertOne',value:function insertOne(vo){var _this2=this;this.assumeIsOwnVoClass(vo);return new _Promise(function(resolve,reject){_this2.getAllVoErrors(vo).then(function(validation){if(validation.hasError()){return reject(validation);}var data=vo.data;_this2.storage.insertOne(data)['catch'](function(err){return reject(new Error('Manager.insertOne() error: ' + err.message));}).then(function(newItemsData){return resolve(_this2.getNewVo(newItemsData));});})['catch'](function(err){return reject(err);});});}},{key:'updateOne',value:function updateOne(vo){var _this3=this;this.assumeIsOwnVoClass(vo);return new _Promise(function(resolve,reject){_this3.getAllVoErrors(vo).then(function(validation){if(validation.hasError()){return reject(validation);}var criteria={_id:vo.id};_this3.storage.updateOne(criteria,vo.data)['catch'](function(err){return reject(new Error('Manager.updateOne() error: ' + err.message));}).then(function(updatedVoData){return resolve(_this3.getNewVo(updatedVoData));});})['catch'](function(err){return reject(err);});});}},{key:'delete',value:function _delete(vosArr){var _this4=this;var idsToDelete=[];vosArr.forEach(function(vo){try{_this4.assumeIsOwnVoClass(vo);if(vo.id){idsToDelete.push(vo.id);}}catch(err) {return null;}});var criteria={_id:{$in:idsToDelete}};return new _Promise(function(resolve,reject){_this4.storage['delete'](criteria).then(function(result){resolve(result.deletedCount);})['catch'](function(err){return reject(err);});});}},{key:'getByUniqueProperty',value:function getByUniqueProperty(property,value){var _this5=this;return new _Promise(function(resolve,reject){if(!_this5.constructor.validatorClass.isPropertyUnique(property)){return reject(new Error('The property "' + property + '" is not unique'));}var criteria={};criteria[property] = value;_this5.get(criteria).then(function(result){switch(result.length){case 0:resolve(null);break;case 1:resolve(result[0]);break;default:reject(new Error('Got multiple object and must only get one'));}},function(err){reject(err);});});}},{key:'getByUniquePropertyM',value:function getByUniquePropertyM(property,values){var _this6=this;return new _Promise(function(resolve,reject){if(!_this6.constructor.validatorClass.isPropertyUnique(property)){return reject(new Error('The property "' + property + '" is not unique'));}if(values.constructor !== Array){return reject(new Error('Values must be an array'));}var criteria={};criteria[property] = {$in:values};_this6.get(criteria).then(function(results){resolve(results);},function(err){reject(err);});});}},{key:'getAllVoErrors',value:function getAllVoErrors(vo){var _this7=this;var skipProperties=arguments.length <= 1 || arguments[1] === undefined?[]:arguments[1];this.assumeIsOwnVoClass(vo);var validationError=new _ValidationError2['default']();return new _Promise(function(resolve,reject){_Promise.all([_this7.getVoFormatErrors(vo),_this7.getVoUniqueErrors(vo),_this7.getVoBusinessErrors(vo)]).then(function(errorsArrays){errorsArrays.map(function(errorsByType){_Object$keys(errorsByType).map(function(field){if(!validationError.hasPropertyError(field) && skipProperties.indexOf(field) < 0){validationError.setPropertyError(field,errorsByType[field]);}});});return resolve(validationError);},function(err){reject(err);});});}},{key:'getVoFormatErrors',value:function getVoFormatErrors(vo){var _this8=this;this.assumeIsOwnVoClass(vo);return new _Promise(function(resolve){var validator=new _this8.constructor.validatorClass(vo);validator.validateVo();resolve(validator.hasError()?validator.errors:{});});}},{key:'getVoUniqueErrors',value:function getVoUniqueErrors(vo){var _this9=this;this.assumeIsOwnVoClass(vo);var result={};var promises=[];this.constructor.validatorClass.uniques.forEach(function(property){var value=vo[property];if(_this9.constructor.validatorClass.needToCheckProperty(property,value)){var p=_this9.getByUniqueProperty(property,value).then(function(foundVo){if(foundVo == null){return null;}if(!vo.id){return property;}if(String(vo.id) === String(foundVo.id)){return null;}return property;});promises.push(p);}});if(promises.length === 0){return _Promise.resolve({});}return _Promise.all(promises).then(function(uniquePromiseResults){uniquePromiseResults.forEach(function(property){if(property){result[property] = new _ValidationPropertyError2['default'](property,'unique');}});return result;});}},{key:'getVoBusinessErrors',value:function getVoBusinessErrors(vo){this.assumeIsOwnVoClass(vo);return new _Promise(function(resolve){return resolve({});});}},{key:'availableMethods',get:function get(){var OwnMethods=_Object$getOwnPropertyNames(Manager.prototype);var childMethods=_Object$getOwnPropertyNames(this.__proto__);var methods=childMethods;OwnMethods.forEach(function(method){if(methods.indexOf(method) < 0){methods.push(method);}});return methods;}}]);return Manager;})();exports['default'] = Manager;Manager.init = function(ManagerChild,VoClass,ValidatorClass){Object.defineProperty(ManagerChild,'voClass',{enumerable:false,writable:false,configurable:false,value:VoClass});Object.defineProperty(ManagerChild,'validatorClass',{enumerable:false,writable:false,configurable:false,value:ValidatorClass});VoClass.getPropertiesNames().forEach(function(property){if(ValidatorClass.isPropertyUnique(property)){var cleanProperty=property.replace(/([^a-z0-9])/ig,'');var methodName='getOneBy' + cleanProperty.charAt(0).toUpperCase() + cleanProperty.substr(1).toLowerCase();_Object$defineProperty(ManagerChild.prototype,methodName,{enumerable:false,writable:false,configurable:false,value:function value(_value){return this.getByUniqueProperty(property,_value);}});}});};module.exports = exports['default'];
//# sourceMappingURL=Manager.js.map